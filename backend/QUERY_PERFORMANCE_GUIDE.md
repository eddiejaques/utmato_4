# Query Performance & Indexing Guide

This guide explains how to apply the new performance indexes, analyze query execution times, and monitor/optimize database performance for the Utmato backend.

---

## 1. Apply the New Alembic Migration

1. **Activate the backend virtual environment:**
   ```bash
   cd backend
   source venv/bin/activate
   ```
2. **Run Alembic migrations:**
   ```bash
   alembic upgrade head
   ```
   This will apply the new indexes for campaigns and UTM links.

---

## 2. Analyze Query Performance with EXPLAIN ANALYZE

1. **Connect to your PostgreSQL database:**
   ```bash
   psql $DATABASE_URL
   ```
2. **Copy the SQL generated by your ORM queries.**
   - You can enable SQL echo in SQLAlchemy or log queries to see the raw SQL.
   - Example (from `search_service.py`):
     ```sql
     SELECT * FROM campaigns WHERE company_id = '<company_id>' AND to_tsvector('english', coalesce(name, '') || ' ' || coalesce(demographics, '') || ' ' || coalesce(interests, '')) @@ to_tsquery('english', '<query>');
     ```
3. **Run EXPLAIN ANALYZE:**
   ```sql
   EXPLAIN ANALYZE <your_query_here>;
   ```
   - This will output the query plan and execution time.
   - Look for slow steps (Seq Scan, Filter, etc.) and check if indexes are being used.

---

## 3. Monitor and Optimize

- **Supabase Analytics:**
  - If using Supabase, use the Analytics dashboard to monitor slow queries and index usage.
- **Optimize Queries:**
  - Use `selectinload` or similar patterns to avoid N+1 queries (already applied in service layer).
  - Add or adjust indexes as needed based on query patterns and EXPLAIN ANALYZE results.
- **Test Performance:**
  - Add or update tests to ensure optimized queries return correct results and perform efficiently.

---

## 4. Troubleshooting

- If a query is still slow after adding indexes:
  - Double-check the query plan with `EXPLAIN ANALYZE`.
  - Consider composite or partial indexes for more specific filtering.
  - Review your ORM query for unnecessary joins or filters.

---

**For further help, see the FastAPI and SQLAlchemy documentation, or contact the backend maintainers.** 